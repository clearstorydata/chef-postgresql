#!/usr/bin/env bash
# Auto-generated by chef
#
# Use this script to fully restore postgres from the backup location configure in <%= @envdir %>
# This will completely remove the existing database.

echo 
echo "This script will destroy all data in <%= @envdir %>!"
echo

today=$(date "+%Y%m%d_%H%M%S")
psql_dir=<%= @datadir %>

echo "Stopping Postgresql"
sudo /etc/init.d/postgresql stop
echo "Moving the postgresql data directory."
sudo mv "${psql_dir}" "${psql_dir}.${today}"
echo "Begin restore of base backup."
sudo -u postgres envdir <%= @envdir %>  /usr/local/bin/wal-e backup-fetch ${psql_dir} LATEST
echo restore_command = 'envdir <%= @envdir %> /usr/local/bin/wal-e wal-fetch "%f" "%p"' | sudo -u postgres tee ${psql_dir}/recovery.conf
echo "Restart postgres to begin restoring remaining WAL files (This will take some time to complete)"
sudo /etc/init.d/postgresql start
echo
echo "The Original postgres data directory has been moved to ${psql_dir}.${today} and should be"
echo "deleted once it has been confirmed that the restore was successful and correct."
echo
